#!/bin/sh

# Stop when any command fails
set -e

install_submodules() {
  echo "Init submodules"
  yadm submodule update --recursive --init
}

install_brew() {
  # install homebrew if it's missing
  if ! command -v brew >/dev/null 2>&1; then
    echo "Installing homebrew"
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi

  if [ -f "${XDG_CONFIG_HOME:-~/.config}/Brewfile" ]; then
    echo "Updating homebrew bundle"
    brew bundle --file="${XDG_CONFIG_HOME:-~/.config}/Brewfile" --verbose
  fi
}

bootstrap_asdf() {
  if ! command -v asdf >/dev/null 2>&1; then
    echo "Installing asdf"
    git clone https://github.com/asdf-vm/asdf.git ~/.asdf
    cd ~/.asdf
    git checkout "$(git describe --abbrev=0 --tags)"
  fi
}

install_alacritty_terminfo() {
  echo "Compiling alacritty terminfo file"
  TMP_DIR=$(mktemp -d)
  cd $TMP_DIR
  curl -O https://raw.githubusercontent.com/alacritty/alacritty/master/extra/alacritty.info
  echo "tic -xe alacritty,alacritty-direct alacritty.info"
  tic -xe alacritty,alacritty-direct alacritty.info
  cd
  rm -rf $TMP_DIR
}

install_tmux_terminfo() {
  echo "Installing tmux terminfo file"
  tic -x $XDG_CONFIG_HOME/tmux/tmux.terminfo
}

bootstrap_tmux() {
  if command -v tmux >/dev/null 2>&1; then
    echo "Installing, updating, and cleaning tmux plugins"

    if [ ! -d "${XDG_CONFIG_HOME:-$HOME/.config}/tmux/tpm" ]; then
      git clone https://github.com/tmux-plugins/tpm \
        "${XDG_CONFIG_HOME:-$HOME/.config}/tmux/tpm"
    fi

    ${XDG_CONFIG_HOME:-$HOME/.config}/tmux/tpm/bin/install_plugins
    ${XDG_CONFIG_HOME:-$HOME/.config}/tmux/tpm/bin/update_plugins all
    ${XDG_CONFIG_HOME:-$HOME/.config}/tmux/tpm/bin/clean_plugins
  fi
}

decrypt_yadm_files() {
  yadm decrypt
  chmod 700 ~/.ssh
  chmod 600 ~/.ssh/id_rsa
  chmod 644 ~/.ssh/id_rsa.pub
}

update_yadm_url_to_ssh() {
  # We now have ssh keys decrypted, so can update the url
  # to be the ssh url
  echo "Updating the yadm repo origin URL"
  yadm remote set-url origin "git@github.com:georgewitteman/dotfiles.git"
}

reminders() {
  echo
  echo "Don't forget to set yadm class!"
  echo "  $ yadm config local.class <work|personal>"
}

decrypt_yadm_files
update_yadm_url_to_ssh
install_submodules
install_brew
bootstrap_asdf
install_alacritty_terminfo
install_tmux_terminfo
bootstrap_tmux

reminders
