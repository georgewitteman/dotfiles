{{- if eq .chezmoi.os "darwin" -}}
#!/bin/sh

if [ -n "$GITHUB_WORKFLOW" ]; then
  echo "::group::Setting up LaunchAgents"
fi

set -e

. "${HOME}/.profile"

echo-info "Setting up LaunchAgents"

agents_path="${HOME}/Library/LaunchAgents"

if [ ! -d "$agents_path" ]; then
  echo-run mkdir -p "$agents_path"
fi

for file in "$HOME"/.config/sh/*/LaunchAgents/*.plist; do
  if [ ! -f "$file" ]; then
    continue
  fi
  dest="${agents_path}/$(basename "$file")"
  echo-run cp "$file" "$dest"
  replace-in-files --verbose '__HOME_DIR__' "$HOME" "$dest"
  echo-run launchctl unload "$dest"
  echo-run launchctl load "$dest"
done

echo-ok "LaunchAgents set up"

if [ -n "$GITHUB_WORKFLOW" ]; then
  echo "::endgroup::"
fi
{{ end -}}
