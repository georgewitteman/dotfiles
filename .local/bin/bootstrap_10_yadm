#!/usr/bin/env zsh

set -e
source "$HOME/.zshrc"

if [[ ! -f "$HOME/.ssh/id_rsa" ]]; then
  echo_run yadm decrypt
  echo_run chmod 700 ~/.ssh
  echo_run chmod 600 ~/.ssh/id_rsa
  echo_run chmod 644 ~/.ssh/id_rsa.pub
  echo_run gpg --import ~/.gnupg/.exports/pgp-public-keys.asc
  echo_run gpg --import ~/.gnupg/.exports/pgp-private-keys.asc
  echo_run gpg --import-ownertrust ~/.gnupg/.exports/pgp-ownertrust.asc
else
  echo_ok "The file ~/.ssh/id_rsa already exists."
  echo_warn "Skipping decryption because it requires a password."
  echo_warn "Run 'yadm decrypt && gpg_restore' if necessary."
fi

echo_run yadm alt

# We now have ssh keys decrypted, so can update the url
# to be the ssh url
echo_info "Updating the yadm repo origin URL."
echo_run yadm remote set-url origin "git@github.com:georgewitteman/dotfiles.git"

echo_run yadm gitconfig pull.rebase true

# Show untracked files since I want to always remember to add new scripts and
# things. The ~/.gitignore should prevent this from getting ugly.
echo_run yadm gitconfig --unset status.showUntrackedFiles || echo_ok "status.showUntrackedFiles already unset."
