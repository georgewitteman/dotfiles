#!/bin/sh

set -o errexit

USAGE="usage: $(basename "$0") [-d|--disconnect] <VPN name>"
VPN_NAME=''

while [ $# -ge 1 ]; do
  case "$1" in
    -h | --help)
      echo "$USAGE"
      exit
      ;;
    -d | --disconnect)
      scutil --nc list | grep Connected 2>&1 | cut -d '"' -f 2 | \
        while read -r; do
          echo-run networksetup -disconnectpppoeservice "$REPLY"
        done
      echo-ok "Disconnected from all VPNs"
      exit $?
      ;;
    --)
      shift
      VPN_NAME="$*"
      break
      ;;
    -*)
      echo-err "unknown option: ${1}"
      exit 1
      ;;
    *)
      VPN_NAME="$1"
  esac
  shift
done

if [ -z "$VPN_NAME" ]; then
  echo-err "A VPN name is required"
  exit 1
fi

if ! scutil --nc list | cut -d '"' -f 2 | grep -q "$VPN_NAME"; then
  echo-err "'${VPN_NAME}' is not a valid VPN"
  exit 1
fi

is_connected() {
  networksetup -showpppoestatus "$VPN_NAME" | grep -q "^connected$"
}

if ! is_connected; then
  echo-run networksetup -connectpppoeservice "$VPN_NAME"
fi

timeout="$(date -v+5S '+%s')"
until is_connected || [ "$(date '+%s')" -gt "$timeout" ]; do
  sleep 0.5
done

if ! is_connected; then
  echo-err "Timed out connecting to VPN"
  exit 1
fi

echo-ok "Connected to VPN"
